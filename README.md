# Ð¡ÐµÑ€Ð²Ð¸Ñ ÐŸÐ»Ð°Ñ‚ÐµÐ¶ÐµÐ¹

Ð¡ÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ **ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹, Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸, Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð°, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð°, Ñ€ÐµÐ²ÐµÑ€ÑÐ°** Ð¸ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð². ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ñ€Ð°Ð·Ð½Ñ‹Ð¼Ð¸ Ð±Ñ€Ð¾ÐºÐµÑ€Ð°Ð¼Ð¸ Ð¸ Ð±Ð°Ð½ÐºÐ°Ð¼Ð¸.

---

## Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸

âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ, Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ, Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð¸ Ñ€ÐµÐ²ÐµÑ€Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹  
âœ… ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹  
âœ… REST & gRPC API Ñ‡ÐµÑ€ÐµÐ· gRPC-Gateway  
âœ… Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ HealthCheck Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ Ð±Ñ€Ð¾ÐºÐµÑ€Ð°  
âœ… ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð»ÑŒÐ½Ñ‹Ñ… Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹  

---

## ÐžÐ±Ð·Ð¾Ñ€ API

- **Base URL:** `http://localhost:8080`  
- **Secured URL:** `https://localhost:8080`  
- **Ð¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ:** OpenAPI 3.0 (Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð· proto Ñ‡ÐµÑ€ÐµÐ· grpc-gateway)

### ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹

| ÐœÐµÑ‚Ð¾Ð´ | Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚                        | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ                                    |
|-------|---------------------------------|---------------------------------------------|
| POST  | `/v1/payments`                  | Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°                            |
| POST  | `/v1/payments/auth`             | ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°                         |
| POST  | `/v1/payments/deposit`          | Ð”ÐµÐ¿Ð¾Ð·Ð¸Ñ‚ (ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²)                  |
| POST  | `/v1/payments/refund`           | Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ ÑÑ€ÐµÐ´ÑÑ‚Ð²                             |
| POST  | `/v1/payments/reversal`         | Ð ÐµÐ²ÐµÑ€Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð° (Ð¾Ñ‚Ð¼ÐµÐ½Ð° Ð¸Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°)         |
| GET   | `/v1/payments/{payment_id}`     | ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ðµ             |
| GET   | `/v1/payments/{payment_id}/status` | ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°      |
| POST  | `/v1/payments/success`          | ÐŸÐ¾Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ ÐºÐ°Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹               |
| GET   | `/v1/payments`                  | Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹ (Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÐµÐ¹)             |
| GET   | `/v1/health`                    | ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ°                  |

---

## ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°

### 1ï¸âƒ£ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PostgreSQL

Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… PostgreSQL, ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼ Ð² `.env` Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ ÑÐµÑ€Ð²Ð¸ÑÐ°.

---

### 2ï¸âƒ£ Ð¤Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ `.env`

ÐŸÑ€Ð¸Ð¼ÐµÑ€ `.env`:

```env
# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°
GRPC_MAX_MESSAGE_SIZE_MIB=12
GRPC_MAX_CONNECTION_AGE=30s
GRPC_MAX_CONNECTION_AGE_GRACE=10s
GRPC_PORT=5433
LEVEL=debug # debug | prod | dev

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
DB_HOST=localhost
DB_PORT=5432
DB_NAME=paymentServiceDB
DB_USER=Bacoonti
DB_PASSWORD=SuperSecretPassword
POSTGRES_MAX_OPEN_CONN=25
POSTGRES_MAX_IDLE_TIME=15m

# API Ð‘Ð°Ð½ÐºÐ° Bereke
BEREKE_MERCHANT_LOGIN=SuperSecretLogin
BEREKE_MERCHANT_PASSWORD=SuperSecretPassword
BEREKE_MERCHANT_MODE=TEST
```


##  ðŸŽ¨ Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
ÐÐ¸Ð¶Ðµ Ð¿Ñ€Ð¸Ð²ÐµÐ´ÐµÐ½Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð¼ÐµÐ¶Ð´Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼, ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð¼, Ð±Ð°Ð½ÐºÐ¾Ð¼ (Merchant Adapter) Ð¸ Ð±Ñ€Ð¾ÐºÐµÑ€Ð¾Ð¼ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹. Ð”Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ñ‹ Ð½Ð° Ñ‚Ñ€Ð¸ Ñ„Ð°Ð·Ñ‹.

**Ð¤Ð°Ð·Ð° 1: ÐŸÑ€ÐµÐ´Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°:**

```mermaid
sequenceDiagram
    actor Client as Client (User)
    participant Service as Service (Shop Backend)
    participant BMA as Merchant (Bank Merchant Adapter)
    participant Broker as Broker (Payment Broker)

    Note over Client,Broker: Phase 1: Order Pre-Authorization

    Client->>Service: (1) Create Order Request <br> Product_ID=123, qty=2
    Service->>Service: Calculate amount = 2000 KZT
    Service->>BMA: (2) Create Order PreAuth <br> {amount=2000, currency=KZT, orderId=ORD-1001}
    BMA->>Broker: (3) POST /registerPreAuth.do <br> payload: {amount, currency, orderId}
    Broker-->>BMA: (4) Response 200 OK <br> {transactionId=TX-abc123, paymentUrl=[https://pay.kz/](https://pay.kz/)...}
    BMA-->>Service: (5) Return PreAuth Result
    Service-->>Client: (6) Provide paymentUrl to redirect
    Client->>Broker: (7) Redirect to paymentUrl (card entry, 3DS, OTP)
    Broker-->>Client: (8) Payment Success Screen
    Client->>Service: (9) Callback/redirect success?orderId=ORD-1001
    Service->>BMA: (10) Verify transaction status
    BMA->>Broker: (11) GET /status.do?tx=TX-abc123
    Broker-->>BMA: (12) status=AUTHORIZED
    BMA-->>Service: (13) status=AUTHORIZED
    Service-->>Client: (14) Order status updated to AUTHORIZED
```

**Ð¤Ð°Ð·Ð° 2: Ð”ÐµÐ¿Ð¾Ð·Ð¸Ñ‚ Ð·Ð°ÐºÐ°Ð·Ð° (ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²)**

```mermaid
sequenceDiagram
    actor Client as Client (User)
    participant Service as Service (Shop Backend)
    participant BMA as Merchant (Bank Merchant Adapter)
    participant Broker as Broker (Payment Broker)

    Note over Client,Broker: Phase 2: Order Deposition (Capture funds)

    Service-->>Client: (1) Provide Product/Service âœ…
    Service->>BMA: (2) Deposit Order <br> {transactionId=TX-abc123, amount=2000}
    BMA->>Broker: (3) POST /deposit.do
    Broker-->>BMA: (4) Response 200 OK <br> {status=DEPOSITED}
    BMA-->>Service: (5) Order deposited
    Service-->>Client: (6) Notify payment completed
```

**Ð¤Ð°Ð·Ð° 3: Ð ÐµÐ²ÐµÑ€ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð° (Ð¾Ñ‚Ð¼ÐµÐ½Ð° Ð¸Ð»Ð¸ ÑÐ±Ð¾Ð¹)**

```mermaid
sequenceDiagram
    actor Client as Client (User)
    participant Service as Service (Shop Backend)
    participant BMA as Merchant (Bank Merchant Adapter)
    participant Broker as Broker (Payment Broker)

    Note over Client,Broker: Phase 3: Order Reversal (Cancel or failure)

    Service-->>Client: (1) Failure occurred âŒ
    Service->>BMA: (2) Reversal Order <br> {transactionId=TX-abc123}
    BMA->>Broker: (3) POST /reverse.do
    Broker-->>BMA: (4) Response 200 OK <br> {status=REVERSED}
    BMA-->>Service: (5) Reversal confirmed
    Service-->>Client: (6) Order has been reversed
```